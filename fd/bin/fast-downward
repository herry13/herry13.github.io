#! /bin/bash

set -e

function get_basedir {
    cd `dirname $0`
    TARGET_FILE=`basename $0`
    while [ -L "$TARGET_FILE" ]
    do
        TARGET_FILE=`readlink $TARGET_FILE`
        cd `dirname $TARGET_FILE`
        TARGET_FILE=`basename $TARGET_FILE`
    done
    PHYS_DIR=`pwd -P`
    echo `dirname "$PHYS_DIR/$TARGET_FILE"`
}

BASEDIR=$(get_basedir)

function die {
    echo "$@" 1>&2
    exit 1
}

function usage {
    die "usage: $(basename "$0") [DOMAIN_FILE] PROBLEM_FILE SEARCH_OPTION ..."
}

# Paths to planner components
TRANSLATE="$BASEDIR/../translate/translate.py"
PREPROCESS="$BASEDIR/../preprocess/preprocess"
SEARCH="$BASEDIR/../search/downward"

TIME="command time -p"


if [[ "$#" -lt 2 ]]; then
    usage
fi

echo "1. Running translator"
if [[ -e "$2" ]]; then
    echo "Second argument is a file name: use two translator arguments."
    $TIME "$TRANSLATE" "$1" "$2"
    shift 2
else
    echo "Second argument is not a file name: auto-detect domain file."
    $TIME "$TRANSLATE" "$1"
    shift
fi
echo

echo "2. Running preprocessor"
$TIME "$PREPROCESS" < output.sas
echo

echo "3. Running search"
"$SEARCH" < output "$@"
echo
